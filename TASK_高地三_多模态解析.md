# ğŸ¬ é«˜åœ°ä¸‰ï¼šå¤šæ¨¡æ€"ç»è‚‰æœº"å®ç°ä»»åŠ¡

**ä¼˜å…ˆçº§ï¼š** â­â­â­â­ï¼ˆé«˜ï¼‰  
**é¢„ä¼°æ—¶é—´ï¼š** 60-90åˆ†é’Ÿ  
**éš¾åº¦ï¼š** ä¸­ç­‰åé«˜  

---

## ğŸ“– ä»»åŠ¡èƒŒæ™¯

å½“å‰æ­¦å™¨åº“åªèƒ½è§£æPDFå’Œæ–‡æœ¬æ–‡ä»¶ï¼Œä½†é”€å”®ç°åœºæœ‰å¤§é‡ï¼š
- ğŸ™ï¸ **å½•éŸ³æ–‡ä»¶** (MP3/WAV) - å®¢æˆ·è®¿è°ˆã€ä¸“å®¶ç­”ç–‘
- ğŸ¬ **è§†é¢‘æ–‡ä»¶** (MP4) - ç°åœºå®å‹˜ã€äº§å“æ¼”ç¤º

è¿™äº›å¤šåª’ä½“èµ„æ–™å«æœ‰å®è´µçš„çŸ¥è¯†ï¼Œå¿…é¡»è½¬åŒ–ä¸ºå¯æ£€ç´¢çš„æ–‡æœ¬ã€‚

---

## ğŸ¯ æ ¸å¿ƒéœ€æ±‚

### åŠŸèƒ½è¦æ±‚

1. **éŸ³é¢‘è½¬å½•**
   - æ”¯æŒæ ¼å¼ï¼šMP3, WAV, M4A
   - ä½¿ç”¨OpenAI Whisper APIè¿›è¡Œè½¬å½•
   - è½¬å½•ç»“æœå­˜å…¥çŸ¥è¯†åº“

2. **è§†é¢‘å¤„ç†**
   - æ”¯æŒæ ¼å¼ï¼šMP4, MOV
   - æå–éŸ³è½¨å¹¶è½¬å½•
   - ï¼ˆå¯é€‰ï¼‰æå–å…³é”®å¸§æè¿°

3. **çŸ¥è¯†åº“é›†æˆ**
   - è½¬å½•æ–‡æœ¬è‡ªåŠ¨å‘é‡åŒ–
   - å¯æœç´¢ã€å¯å¼•ç”¨
   - æ ‡æ³¨æ¥æºï¼ˆå¦‚"å½•éŸ³.mp3 03:25"ï¼‰

---

## ğŸ”§ æŠ€æœ¯è§„æ ¼

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

**1. utils/rag_engine.py**

åœ¨ `process_document()` æ–¹æ³•ä¸­ï¼Œæ‰¾åˆ°è¿™æ®µä»£ç ï¼š

```python
elif file_ext in ['mp4', 'mp3', 'wav']:
    content = f"[å¤šåª’ä½“æ–‡ä»¶] {file_name}\n(å¤šåª’ä½“æ–‡ä»¶å·²è®°å½•ï¼Œå¾…å®ç°è½¬å½•åŠŸèƒ½)"
```

**æ›¿æ¢ä¸ºçœŸå®è½¬å½•é€»è¾‘ï¼š**

```python
elif file_ext in ['mp3', 'wav', 'm4a']:
    # éŸ³é¢‘è½¬å½•
    content = self._transcribe_audio(file_bytes, file_name)
    
elif file_ext in ['mp4', 'mov']:
    # è§†é¢‘å¤„ç†ï¼ˆæå–éŸ³è½¨å¹¶è½¬å½•ï¼‰
    content = self._transcribe_video(file_bytes, file_name)
```

**2. æ–°å¢è½¬å½•æ–¹æ³•**

åœ¨ `RAGEngine` ç±»ä¸­æ·»åŠ ï¼š

```python
def _transcribe_audio(self, file_bytes: bytes, file_name: str) -> str:
    """
    è½¬å½•éŸ³é¢‘æ–‡ä»¶
    
    Args:
        file_bytes: éŸ³é¢‘å­—èŠ‚æµ
        file_name: æ–‡ä»¶å
    
    Returns:
        è½¬å½•æ–‡æœ¬
    """
    try:
        import openai
        import io
        
        # è·å–APIå¯†é’¥ï¼ˆä»ç¯å¢ƒå˜é‡æˆ–é…ç½®ï¼‰
        api_key = os.environ.get('OPENAI_API_KEY')
        if not api_key:
            return f"[éŸ³é¢‘æ–‡ä»¶] {file_name}\n(éœ€è¦é…ç½®OpenAI APIå¯†é’¥è¿›è¡Œè½¬å½•)"
        
        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
        audio_file = io.BytesIO(file_bytes)
        audio_file.name = file_name
        
        # è°ƒç”¨Whisper API
        client = openai.OpenAI(api_key=api_key)
        transcript = client.audio.transcriptions.create(
            model="whisper-1",
            file=audio_file,
            language="zh"  # ä¸­æ–‡
        )
        
        # æ ¼å¼åŒ–ç»“æœ
        result = f"[éŸ³é¢‘è½¬å½•] {file_name}\n\n"
        result += transcript.text
        
        return result
        
    except Exception as e:
        return f"[éŸ³é¢‘æ–‡ä»¶] {file_name}\nè½¬å½•å¤±è´¥: {str(e)}"


def _transcribe_video(self, file_bytes: bytes, file_name: str) -> str:
    """
    å¤„ç†è§†é¢‘æ–‡ä»¶ï¼ˆæå–éŸ³è½¨å¹¶è½¬å½•ï¼‰
    
    Args:
        file_bytes: è§†é¢‘å­—èŠ‚æµ
        file_name: æ–‡ä»¶å
    
    Returns:
        è½¬å½•æ–‡æœ¬
    """
    try:
        # æ–¹æ¡ˆ1ï¼šç›´æ¥è®°å½•ï¼ˆå¦‚æœè§†é¢‘å¤ªå¤§ï¼‰
        file_size_mb = len(file_bytes) / (1024 * 1024)
        if file_size_mb > 25:  # Whisper APIé™åˆ¶25MB
            return f"[è§†é¢‘æ–‡ä»¶] {file_name}\næ–‡ä»¶è¿‡å¤§({file_size_mb:.1f}MB)ï¼Œå»ºè®®å…ˆæå–éŸ³è½¨"
        
        # æ–¹æ¡ˆ2ï¼šä½¿ç”¨ffmpegæå–éŸ³è½¨ï¼ˆéœ€è¦å®‰è£…ffmpegï¼‰
        # è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥å°è¯•è½¬å½•
        import openai
        import io
        
        api_key = os.environ.get('OPENAI_API_KEY')
        if not api_key:
            return f"[è§†é¢‘æ–‡ä»¶] {file_name}\n(éœ€è¦é…ç½®OpenAI APIå¯†é’¥è¿›è¡Œè½¬å½•)"
        
        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
        video_file = io.BytesIO(file_bytes)
        video_file.name = file_name
        
        # è°ƒç”¨Whisper APIï¼ˆWhisperå¯ä»¥ç›´æ¥å¤„ç†è§†é¢‘ï¼‰
        client = openai.OpenAI(api_key=api_key)
        transcript = client.audio.transcriptions.create(
            model="whisper-1",
            file=video_file,
            language="zh"
        )
        
        result = f"[è§†é¢‘è½¬å½•] {file_name}\n\n"
        result += transcript.text
        
        return result
        
    except Exception as e:
        return f"[è§†é¢‘æ–‡ä»¶] {file_name}\nè½¬å½•å¤±è´¥: {str(e)}\nå»ºè®®ï¼šæ–‡ä»¶å¯èƒ½è¿‡å¤§æˆ–æ ¼å¼ä¸æ”¯æŒ"
```

**3. è·å–APIå¯†é’¥**

åœ¨ `app.py` ä¸­ï¼ŒAPIå¯†é’¥å·²ç»åœ¨ä¾§è¾¹æ è¾“å…¥ï¼Œéœ€è¦ç¡®ä¿ä¼ é€’ç»™RAGå¼•æ“ï¼š

```python
# åœ¨åˆå§‹åŒ–RAGå¼•æ“æ—¶
if "rag_engine" not in st.session_state:
    from utils.rag_engine import get_rag_engine
    st.session_state.rag_engine = get_rag_engine()

# è®¾ç½®APIå¯†é’¥ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
if api_key:
    os.environ['OPENAI_API_KEY'] = api_key
```

---

## ğŸ“‹ éªŒæ”¶æ ‡å‡†

### å¿…é¡»è¾¾åˆ°

- [ ] MP3æ–‡ä»¶ä¸Šä¼ åèƒ½è½¬å½•
- [ ] è½¬å½•æ–‡æœ¬å­˜å…¥çŸ¥è¯†åº“
- [ ] è½¬å½•å†…å®¹å¯æœç´¢
- [ ] è½¬å½•å†…å®¹å¯åœ¨é—®ç­”ä¸­å¼•ç”¨
- [ ] æ–‡ä»¶å¤§å°éªŒè¯ï¼ˆ<25MBï¼‰
- [ ] å¼‚å¸¸å¤„ç†å®Œå–„

### åŠ åˆ†é¡¹

- [ ] æ˜¾ç¤ºè½¬å½•è¿›åº¦
- [ ] æ”¯æŒæ—¶é—´æˆ³ï¼ˆå¦‚"03:25å¤„æåˆ°..."ï¼‰
- [ ] è§†é¢‘å…³é”®å¸§æå–
- [ ] å¤šè¯­è¨€æ”¯æŒ

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### å‡†å¤‡æµ‹è¯•æ–‡ä»¶

åˆ›å»ºä¸€ä¸ªç®€çŸ­çš„æµ‹è¯•éŸ³é¢‘ï¼ˆå¯ä»¥ç”¨æ‰‹æœºå½•éŸ³ï¼‰ï¼š

**å†…å®¹å»ºè®®ï¼š**
```
"ä¸‡åé˜²è…æ¶‚æ–™WH-2026-Aåœ¨é•‡æµ·ç‚¼åŒ–é¡¹ç›®ä¸­çš„è¡¨ç°éå¸¸å‡ºè‰²ï¼Œ
è€ç›é›¾æµ‹è¯•è¶…è¿‡3000å°æ—¶ï¼Œå®¢æˆ·åé¦ˆä½¿ç”¨å¯¿å‘½å¯è¾¾15å¹´ä»¥ä¸Šã€‚
è¿™ä¸ªäº§å“ç‰¹åˆ«é€‚åˆæµ·æ´‹ç¯å¢ƒã€‚"
```

ä¿å­˜ä¸ºï¼š`test_audio_å®¢æˆ·è®¿è°ˆ.mp3`

### æµ‹è¯•æ­¥éª¤

1. **ä¸Šä¼ éŸ³é¢‘**
   - è¿›å…¥"æ ¸å¿ƒæŠ€æœ¯æ­¦å™¨åº“"
   - é€‰æ‹©åˆ†ç±»ï¼š"ğŸ™ï¸ ä¸“å®¶ç­”ç–‘å½•éŸ³"
   - ä¸Šä¼  `test_audio_å®¢æˆ·è®¿è°ˆ.mp3`
   - ç‚¹å‡»"ä¸€é”®å‘é‡åŒ–å¹¶è£…å¡«å…¥åº“"

2. **éªŒè¯è½¬å½•**
   - è§‚å¯Ÿä¸Šä¼ è¿‡ç¨‹ï¼Œåº”æ˜¾ç¤º"æ­£åœ¨è½¬å½•..."
   - æ£€æŸ¥ç»Ÿè®¡é¢æ¿ï¼Œæ–‡æ¡£æ•°+1
   - åœ¨æ–‡æ¡£åˆ—è¡¨ä¸­æŸ¥çœ‹ï¼ŒçŠ¶æ€åº”ä¸º"å·²å…¥åº“"

3. **æµ‹è¯•æœç´¢**
   - æœç´¢ï¼š"é•‡æµ·ç‚¼åŒ–ä½¿ç”¨æ•ˆæœ"
   - åº”è¯¥èƒ½æ‰¾åˆ°è½¬å½•çš„éŸ³é¢‘å†…å®¹
   - ç›¸å…³åº¦åº”åˆç†ï¼ˆ>60%ï¼‰

4. **æµ‹è¯•é—®ç­”**
   - è¿›å…¥"ç¬¬ä¸€ç°åœº"
   - æé—®ï¼š"é•‡æµ·ç‚¼åŒ–é¡¹ç›®ä¸­æ¶‚æ–™è¡¨ç°å¦‚ä½•ï¼Ÿ"
   - ç­”æ¡ˆåº”å¼•ç”¨éŸ³é¢‘è½¬å½•å†…å®¹

### é¢„æœŸç»“æœ

**ä¸Šä¼ æˆåŠŸï¼š**
```
ğŸ§  æ­£åœ¨è§£æ: test_audio_å®¢æˆ·è®¿è°ˆ.mp3 (1/1)
   æ­£åœ¨è½¬å½•éŸ³é¢‘...ï¼ˆçº¦10-30ç§’ï¼‰

âœ… æˆåŠŸè§£æå¹¶å‘é‡åŒ–ï¼štest_audio_å®¢æˆ·è®¿è°ˆ.mp3 (1ä¸ªçŸ¥è¯†ç¢ç‰‡)

å†…å®¹é¢„è§ˆï¼š
[éŸ³é¢‘è½¬å½•] test_audio_å®¢æˆ·è®¿è°ˆ.mp3

ä¸‡åé˜²è…æ¶‚æ–™WH-2026-Aåœ¨é•‡æµ·ç‚¼åŒ–é¡¹ç›®ä¸­çš„è¡¨ç°éå¸¸å‡ºè‰²...
```

**æœç´¢ç»“æœï¼š**
```
ğŸŸ¢ ç»“æœ 1: test_audio_å®¢æˆ·è®¿è°ˆ.mp3 (85%)
   [éŸ³é¢‘è½¬å½•]
   ä¸‡åé˜²è…æ¶‚æ–™WH-2026-Aåœ¨é•‡æµ·ç‚¼åŒ–é¡¹ç›®ä¸­...
```

**é—®ç­”å¼•ç”¨ï¼š**
```
æ ¹æ®å®¢æˆ·è®¿è°ˆå½•éŸ³[æ–‡æ¡£1]ï¼Œä¸‡åé˜²è…æ¶‚æ–™WH-2026-Aåœ¨é•‡æµ·ç‚¼åŒ–
é¡¹ç›®ä¸­è¡¨ç°éå¸¸å‡ºè‰²ï¼Œè€ç›é›¾æµ‹è¯•è¶…è¿‡3000å°æ—¶...

ğŸ“š æŸ¥çœ‹å‚è€ƒæ¥æº
ğŸŸ¢ [æ–‡æ¡£1] test_audio_å®¢æˆ·è®¿è°ˆ.mp3 (ä¸“å®¶ç­”ç–‘å½•éŸ³)
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. APIæˆæœ¬

- Whisper APIæŒ‰æ—¶é•¿æ”¶è´¹ï¼š$0.006/åˆ†é’Ÿ
- 5åˆ†é’ŸéŸ³é¢‘ â‰ˆ $0.03
- å»ºè®®æç¤ºç”¨æˆ·éŸ³é¢‘é•¿åº¦é™åˆ¶

### 2. æ–‡ä»¶å¤§å°

- Whisper APIé™åˆ¶ï¼š25MB
- è¶…è¿‡é™åˆ¶éœ€è¦å…ˆå‹ç¼©æˆ–åˆ†æ®µ

### 3. å¤„ç†æ—¶é—´

- 1åˆ†é’ŸéŸ³é¢‘ â‰ˆ 5-10ç§’è½¬å½•æ—¶é—´
- éœ€è¦æ˜¾ç¤ºè¿›åº¦æç¤º

### 4. é”™è¯¯å¤„ç†

å¸¸è§é”™è¯¯ï¼š
- APIå¯†é’¥æ— æ•ˆ â†’ å‹å¥½æç¤º
- æ–‡ä»¶è¿‡å¤§ â†’ å»ºè®®å‹ç¼©
- æ ¼å¼ä¸æ”¯æŒ â†’ å»ºè®®è½¬æ¢
- ç½‘ç»œè¶…æ—¶ â†’ è‡ªåŠ¨é‡è¯•

---

## ğŸ“‚ ç›¸å…³èµ„æ–™

### OpenAI Whisper APIæ–‡æ¡£

```python
# åŸºæœ¬ç”¨æ³•
import openai

client = openai.OpenAI(api_key="YOUR_API_KEY")

with open("audio.mp3", "rb") as audio_file:
    transcript = client.audio.transcriptions.create(
        model="whisper-1",
        file=audio_file,
        language="zh",  # å¯é€‰ï¼šæŒ‡å®šè¯­è¨€
        response_format="text"  # æˆ– "json", "srt", "vtt"
    )

print(transcript.text)
```

### æ”¯æŒçš„æ ¼å¼

- éŸ³é¢‘ï¼šmp3, mp4, mpeg, mpga, m4a, wav, webm
- è§†é¢‘ï¼šmp4, mpeg, mpga, m4a, wav, webm, mov

---

## ğŸš€ æ‰©å±•åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

### 1. æ—¶é—´æˆ³æ”¯æŒ

```python
# è¿”å›å¸¦æ—¶é—´æˆ³çš„è½¬å½•
transcript = client.audio.transcriptions.create(
    model="whisper-1",
    file=audio_file,
    response_format="verbose_json",  # åŒ…å«æ—¶é—´æˆ³
    timestamp_granularities=["segment"]
)

# æ ¼å¼åŒ–ä¸º "[00:32] å†…å®¹..."
```

### 2. è§†é¢‘å…³é”®å¸§

ä½¿ç”¨OpenAI Vision APIåˆ†æè§†é¢‘å…³é”®å¸§ï¼š

```python
# æå–å…³é”®å¸§ â†’ Base64ç¼–ç  â†’ GPT-4Våˆ†æ
```

### 3. è¯´è¯äººè¯†åˆ«

```python
# ä½¿ç”¨pyannote.audioè¯†åˆ«ä¸åŒè¯´è¯äºº
# "å®¢æˆ·: ..." vs "é”€å”®: ..."
```

---

## âœ… å®Œæˆæ ‡å¿—

æäº¤ä»¥ä¸‹å†…å®¹å³è¡¨ç¤ºä»»åŠ¡å®Œæˆï¼š

1. **ä¿®æ”¹çš„æ–‡ä»¶**
   - `utils/rag_engine.py` - æ·»åŠ è½¬å½•æ–¹æ³•
   - `app.py` - APIå¯†é’¥ä¼ é€’ï¼ˆå¦‚éœ€è¦ï¼‰

2. **æµ‹è¯•ç»“æœ**
   - æˆåŠŸè½¬å½•çš„éŸ³é¢‘æ–‡ä»¶æˆªå›¾
   - æœç´¢ç»“æœæˆªå›¾
   - é—®ç­”å¼•ç”¨æˆªå›¾

3. **è¯´æ˜æ–‡æ¡£**
   - å¦‚ä½•ä½¿ç”¨æ–°åŠŸèƒ½
   - å·²æµ‹è¯•çš„æ–‡ä»¶æ ¼å¼
   - é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

---

**å‡†å¤‡å¥½äº†å—ï¼Ÿå¼€å§‹å®ç°å§ï¼** ğŸ¬

æˆ‘ä¼šå®æ—¶ç›‘æ§è¿›åº¦å¹¶è¿›è¡Œæµ‹è¯•éªŒè¯ã€‚
