import json
import re
import io
import base64
import difflib
import datetime
import PyPDF2

import openai
import streamlit as st
import streamlit.components.v1 as components
from database import (init_db, insert_visit_log, get_all_logs, add_project, get_projects,
                      get_logs_by_project, save_intelligence, get_all_projects, get_project_data,
                      get_user_blind_spots, save_test_record, get_all_test_records)
from llm_service import (parse_visit_log, parse_visit_log_with_image, encode_image,
                         chat_with_project, chat_with_project_stream,
                         generate_quiz, critique_answer, generate_team_report,
                         generate_followup_email, generate_tech_summary,
                         generate_insider_ammo, transcribe_audio)
from modules import render_sandbox_tab, render_learning_tab, render_leader_tab

# â”€â”€ å…¨å±€é»˜è®¤é…ç½® (Data Dictionary) â”€â”€
DEFAULT_CONFIGS = {
    "project_stages": [
        "åˆæœŸæ¥è§¦", "æ–¹æ¡ˆæŠ¥ä»·", "å•†åŠ¡è°ˆåˆ¤",
        "æŠ€æœ¯åƒµæŒ", "é€¼å•/ç­¾çº¦", "ä¸¢å•å½’æ¡£",
    ],
    "pain_point_options": [
        "å·¥æœŸæå…¶ç´§å¼ ", "æ•´ä½“é¢„ç®—å—é™", "åæœŸç»´æŠ¤æˆæœ¬é«˜",
        "å®‰è£…ç©ºé—´å—é™", "è¿è¡Œç¯å¢ƒæ¶åŠ£(é«˜è…èš€/é«˜ç²‰å°˜)",
        "éœ€è¦æ™ºèƒ½åŒ–å‡çº§",
    ],
    "role_options": [
        "å†³ç­–è€… (å…³æ³¨ROI/é£é™©)",
        "ä½¿ç”¨è€… (å…³æ³¨æ˜“ç”¨/å…ç»´æŠ¤)",
        "å½±å“è€… (å…³æ³¨å‚æ•°/åˆè§„)",
        "æ•™ç»ƒ/å†…çº¿ (å…³æ³¨æ§æ ‡/æ±‡æŠ¥)",
    ],
    "leader_attitudes": [
        "æåº¦çœ‹é‡åˆæœŸæŠ•å…¥æˆæœ¬ (å¯¹ä»·æ ¼æå…¶æ•æ„Ÿ)",
        "ç»å¯¹è¿·ä¿¡å¤§å“ç‰Œ/æ±‚ç¨³æ€•æ‹…è´£ (åªä¿¡è¥¿é—¨å­/ABBç­‰å¤§å‚)",
        "æåº¦çœ‹é‡å·¥æœŸå’ŒæŠ•äº§èŠ‚ç‚¹ (å¯¹æ—¶é—´/äº¤æœŸæåº¦ç„¦è™‘)",
        "çœ‹é‡å…¨ç”Ÿå‘½å‘¨æœŸä¸é•¿æœŸç»å¯¹å®‰å…¨ (ä»·å€¼ä¸è´¨é‡å¯¼å‘)",
    ],
    "leader_histories": [
        "é¦–æ¬¡æ¥è§¦æˆ‘ä»¬ï¼Œé˜²å¤‡å¿ƒè¾ƒé‡",
        "å†å²åˆä½œè¿‡ï¼Œå¯¹æˆ‘ä»¬æœ‰ä¸€å®šä¿¡ä»»åŸºç¡€",
        "è¿‡å»æ›¾è¢«å‹å•†(æˆ–ä½ä»·è®¾å¤‡)å‘è¿‡ï¼Œå¿ƒæœ‰ä½™æ‚¸",
        "å¯¹å„å®¶æ–¹æ¡ˆå‡ä¸æ»¡æ„ï¼Œå¤„äºæ‘‡æ‘†è§‚æœ›çŠ¶æ€",
    ],
    "info_sources": [
        "é«˜å±‚å®¢æƒ…/å†…çº¿é€éœ² (å¯ä¿¡åº¦æé«˜)",
        "è®¾è®¡é™¢/åˆä½œä¼™ä¼´å¼•å…¥ (å¸¦æœ‰ä¸€å®šå€¾å‘æ€§)",
        "å…¬å¼€æ‹›æ ‡/é‡‡è´­ç½‘ (å…¬å¼€ç«äº‰/å†…å®šé£é™©é«˜)",
        "é™Œæ‹œ/å±•ä¼šæŒ–æ˜ (å¤„äºææ—©æœŸ)",
        "å‹å•†æ¸ é“æµå‡º (éœ€é˜²èŒƒå‡æ¶ˆæ¯)",
    ],
    "project_drivers": [
        "è€æ—§è®¾å¤‡æ”¹é€ /æ¶ˆé™¤éšæ‚£ (å…³æ³¨ç—›ç‚¹)",
        "äº§èƒ½æ‰©å»º/æ–°å»ºå‚æˆ¿ (å…³æ³¨å·¥æœŸ)",
        "å“åº”æ”¿ç­–/ç¯ä¿åˆè§„ (å…³æ³¨æŒ‡æ ‡)",
        "æ•°å­—åŒ–/æ™ºèƒ½åŒ–å‡çº§ (å…³æ³¨æ–°æŠ€æœ¯)",
    ],
    "position_options": [
        "é¢†è·‘ (å‚ä¸æ ‡å‡†åˆ¶å®š/å·²é”å®šå…³é”®äºº)",
        "å¹¶è·‘ (å¸¸è§„æŠ€æœ¯äº¤æµä¸­ï¼Œæœ‰ç«äº‰)",
        "è·Ÿè·‘/é™ªè·‘ (ä»‹å…¥è¾ƒæ™š/ç«å“æ˜æ˜¾å ä¼˜)",
        "æœªçŸ¥ (åˆšè·å–ä¿¡æ¯ï¼Œå±€åŠ¿ä¸æ˜)",
    ],
    "budget_statuses": [
        "é¢„ç®—å·²å…¨é¢æ‰¹å¤ (éšæ—¶å¯é‡‡)",
        "éƒ¨åˆ†èµ„é‡‘åˆ°ä½/è¾¹å»ºè¾¹æ‰¹ (æœ‰æ‰¯çš®é£é™©)",
        "æ­£åœ¨ç”³æŠ¥é¢„ç®— (å¯å¼•å¯¼é¢„ç®—é‡‘é¢)",
        "èµ„é‡‘æ¥æºä¸æ˜/è‡ªç­¹ (è­¦æƒ•çƒ‚å°¾)",
    ],
}


# æŸ”æ€§è¯„ä»·ä½“ç³»é»˜è®¤ç»´åº¦ï¼ˆå„é¡¹ç‹¬ç«‹ 0-100 è¯„ä¼°æƒé‡ï¼‰
DEFAULT_EVAL_DIMENSIONS = {
    "M â€” é‡åŒ–æŒ‡æ ‡ (Metrics)": 80,
    "E â€” ç»æµå†³ç­–è€… (Economic Buyer)": 100,
    "D â€” å†³ç­–æ ‡å‡† (Decision Criteria)": 70,
    "D â€” å†³ç­–æµç¨‹ (Decision Process)": 70,
    "I â€” æ ¸å¿ƒç—›ç‚¹ (Identify Pain)": 90,
    "C â€” å†…éƒ¨æ•™ç»ƒ (Champion)": 90,
    "R â€” åˆ©ç›Šå…³ç³»æ†ç»‘ (Relationship)": 85,
}


def _init_dynamic_options():
    """ç»Ÿä¸€åˆå§‹åŒ–æ‰€æœ‰åŠ¨æ€ä¸‹æ‹‰é€‰é¡¹åˆ° session_stateï¼ˆä»…é¦–æ¬¡åŠ è½½æ—¶æ‰§è¡Œï¼‰ã€‚"""
    for key, defaults in DEFAULT_CONFIGS.items():
        if key not in st.session_state:
            st.session_state[key] = list(defaults)  # æ·±æ‹·è´ï¼Œé¿å…ä¿®æ”¹å…¨å±€é»˜è®¤
    # åˆå§‹åŒ–æŸ”æ€§è¯„ä»·ç»´åº¦
    if "eval_dimensions" not in st.session_state:
        st.session_state.eval_dimensions = dict(DEFAULT_EVAL_DIMENSIONS)
    # åˆå§‹åŒ–ç«‹é¡¹å®¡æ ¸ç¼“å†²æ± ï¼ˆlist of dictsï¼‰
    if not isinstance(st.session_state.get("pending_projects"), list):
        st.session_state.pending_projects = []  # [{client, project_name, dept, applicant, time, ...}]
    # åˆå§‹åŒ–å…¨å±€å®ä½“åº“ (Entity First CRM æ¶æ„)
    if "entities" not in st.session_state:
        st.session_state.entities = {
            "ä¸šä¸»æ–¹": ["ä¸‡ååŒ–å­¦", "ä¸­çŸ³åŒ–", "ä¸­çŸ³æ²¹", "å·´æ–¯å¤«", "å®å¾·æ—¶ä»£", "æ¯”äºšè¿ª"],
            "è®¾è®¡é™¢": ["ä¸­å›½çŸ³åŒ–å·¥ç¨‹å»ºè®¾å…¬å¸ (SEI)", "åé™†å·¥ç¨‹ç§‘æŠ€", "ä¸­å›½å¤©è¾°å·¥ç¨‹ (TCC)", "ä¸­å›½å¯°çƒå·¥ç¨‹å…¬å¸ (HQCEC)", "åä¸œå»ºç­‘è®¾è®¡ç ”ç©¶é™¢"],
            "æ€»åŒ…æ–¹": ["ä¸­å»ºä¸‰å±€", "ä¸­å»ºå…«å±€"]
        }
    # åˆå§‹åŒ–æ³¨å†Œè¡¨å•æ­¥éª¤
    if "reg_form_step" not in st.session_state:
        st.session_state.reg_form_step = 1
    if "form_key" not in st.session_state:
        st.session_state.form_key = 0
    if "project_name_cache" not in st.session_state:
        st.session_state.project_name_cache = []
        try:
            # åˆæ¬¡åŠ è½½æ—¶ï¼Œä»æ•°æ®åº“æ‹‰å–å…¨é‡æ•°æ®å¹¶è¿›è¡Œ"ä¸‡èƒ½æ¸…æ´—"
            db_data = get_all_projects()
            if db_data:
                for p in db_data:
                    # ä¸‡èƒ½è§£åŒ…ï¼šæ— è®ºè€æ¿çš„ DB è¿”å›çš„æ˜¯å­—å…¸ã€å…ƒç»„è¿˜æ˜¯å¯¹è±¡
                    if isinstance(p, dict):
                        name = p.get('project_name') or p.get('name') or p.get('id') or str(p)
                    elif isinstance(p, (list, tuple)) and len(p) > 1:
                        name = str(p[1])  # project_name åœ¨ç¬¬äºŒåˆ— (ç¬¬ä¸€åˆ—æ˜¯ project_id)
                    elif isinstance(p, (list, tuple)) and len(p) == 1:
                        name = str(p[0])
                    else:
                        name = str(p)
                    st.session_state.project_name_cache.append(name)
        except Exception as e:
            print(f"æ•°æ®åº“é¢„çƒ­å¼‚å¸¸: {e}")
    # åˆå§‹åŒ–æ­£å¼é¡¹ç›®å®ä½“åº“ (å¯Œå­—å…¸ç»“æ„ï¼Œä¾›æ²™ç›˜æƒé™è¿‡æ»¤)
    if "projects" not in st.session_state:
        st.session_state.projects = {}
        try:
            db_data = get_all_projects()
            if db_data:
                for p in db_data:
                    name = str(p[1]) if isinstance(p, (list, tuple)) and len(p) > 1 else str(p)
                    parts = name.split(" - ")
                    st.session_state.projects[name] = {
                        "db_id": p[0] if isinstance(p, (list, tuple)) else None,
                        "client": parts[0] if len(parts) >= 1 else "æœªçŸ¥ä¸šä¸»",
                        "design_institute": parts[2] if len(parts) >= 3 else "",
                        "general_contractor": "",
                        "applicant": "å†å²æ•°æ®",
                        "dept": "æœªçŸ¥æˆ˜åŒº",
                    }
        except Exception as e:
            print(f"é¡¹ç›®å®ä½“åº“é¢„çƒ­å¼‚å¸¸: {e}")


# â”€â”€ æœ¬åœ°éšç§è„±æ• â”€â”€

def mask_sensitive_info(text: str) -> str:
    """å¯¹æ–‡æœ¬è¿›è¡Œæœ¬åœ°éšç§è„±æ•ï¼šæ‰‹æœºå· & é‡‘é¢ã€‚"""
    # è§„åˆ™ 1ï¼š11 ä½è¿ç»­æ•°å­—ï¼ˆæ‰‹æœºå·ï¼‰
    text = re.sub(r"\b1[3-9]\d{9}\b", "[PHONE_MASK]", text)
    # è§„åˆ™ 2ï¼šæ•°å­—+ä¸‡/å…ƒï¼ˆé‡‘é¢ï¼‰
    text = re.sub(r"\d+(\.\d+)?\s*[ä¸‡å…ƒ]", "[MONEY_MASK]", text)
    return text


# åˆå§‹åŒ–æ•°æ®åº“
init_db()
_init_dynamic_options()

# é¡µé¢é…ç½®
st.set_page_config(page_title="SRI ä½œæˆ˜æŒ‡æŒ¥å®¤", layout="wide")

# --- éšè— Streamlit é»˜è®¤çš„å¼€å‘è€…èœå•å’Œé¡µè„šï¼Œæ‰“é€ æ²‰æµ¸å¼ä½“éªŒ ---
hide_streamlit_style = """
<style>
/* éšè—å³ä¸Šè§’çš„ Deploy æŒ‰é’® */
.stDeployButton {
    visibility: hidden;
}
/* éšè—å³ä¸Šè§’çš„ä¸‰é“æ èœå• */
#MainMenu {
    visibility: hidden;
}
/* éšè—åº•éƒ¨çš„ "Made with Streamlit" */
footer {
    visibility: hidden;
}
</style>
"""
st.markdown(hide_streamlit_style, unsafe_allow_html=True)


# â”€â”€ è¯­éŸ³æ–‡æœ¬è¾“å…¥ç»„ä»¶ï¼ˆå¼ºåˆ¶ç®€ä½“ä¸­æ–‡ï¼‰ â”€â”€
def _voice_stt_block(label, key):
    """å†…éƒ¨å¤ç”¨ï¼šæ¸²æŸ“å½•éŸ³é¢æ¿ + Whisper STTï¼Œè½¬å†™ç»“æœå†™å…¥ session_state[key]"""
    short_label = label.split("ï¼š")[0].split("(")[0].strip()
    with st.expander(f"ğŸ™ï¸ ç‚¹å‡»å¼€å¯è¯­éŸ³è¾“å…¥ï¼š{short_label}", expanded=False):
        audio_value = st.audio_input("è¯´è¯ç»“æŸè¯·å†æ¬¡ç‚¹å‡»ä»¥è½¬æ–‡å­—", key=f"audio_{key}")

    if audio_value and audio_value != st.session_state.get(f"last_audio_{key}"):
        _api_key = st.session_state.get("api_key_value", "")
        if not _api_key:
            st.warning("è¯·å…ˆåœ¨å·¦ä¾§ä¾§è¾¹æ è¾“å…¥ API Key ä»¥å¯ç”¨è¯­éŸ³è¯†åˆ«ï¼")
        else:
            with st.spinner("ğŸ§  æ­£åœ¨å°†æ‚¨çš„å£è¿°è½¬ä¸ºç®€ä½“æ–‡å­—..."):
                try:
                    audio_bytes = audio_value.read()
                    audio_file = io.BytesIO(audio_bytes)
                    audio_file.name = "audio.wav"

                    from openai import OpenAI as _OpenAI
                    _client = _OpenAI(api_key=_api_key)
                    transcript_text = _client.audio.transcriptions.create(
                        model="whisper-1",
                        file=audio_file,
                        language="zh",
                        prompt="ä»¥ä¸‹æ˜¯ä¸€æ®µç®€ä½“ä¸­æ–‡çš„ä¸šåŠ¡è®°å½•ï¼Œè¯·åŠ¡å¿…ä½¿ç”¨ç®€ä½“ä¸­æ–‡è¾“å‡ºï¼š",
                        response_format="text",
                    )

                    current_text = st.session_state.get(key, "")
                    if current_text:
                        st.session_state[key] = current_text + "\n" + transcript_text
                    else:
                        st.session_state[key] = transcript_text

                    st.session_state[f"last_audio_{key}"] = audio_value
                    st.rerun()
                except Exception as e:
                    st.error(f"è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ï¼š{e}")


def voice_text_area(label, key, placeholder="", height=150):
    """å¸¦è¯­éŸ³å½•å…¥çš„ text_areaï¼ˆå¼ºåˆ¶ç®€ä½“ä¸­æ–‡ï¼‰"""
    _voice_stt_block(label, key)
    return st.text_area(label, key=key, placeholder=placeholder, height=height)


def voice_text_input(label, key, placeholder=""):
    """å¸¦è¯­éŸ³å½•å…¥çš„ text_inputï¼ˆå¼ºåˆ¶ç®€ä½“ä¸­æ–‡ï¼‰"""
    _voice_stt_block(label, key)
    return st.text_input(label, key=key, placeholder=placeholder)

# â”€â”€ ä¾§è¾¹æ  â”€â”€
with st.sidebar:
    # --- ç½®é¡¶çš„é‡ç½®æŒ‰é’® ---
    if st.button("ğŸ”„ åˆ·æ–°/é‡ç½®ç³»ç»ŸçŠ¶æ€", use_container_width=True):
        st.rerun()
    st.markdown("---")

    st.header("âš™ï¸ ç³»ç»Ÿè®¾ç½®")
    api_key = st.text_input("è¯·è¾“å…¥å¤§æ¨¡å‹ API Key", type="password")
    st.session_state["api_key_value"] = api_key  # ä¾› voice_enabled_text_widget è¯»å–

    # æ¸…ç©ºè¾“å…¥æ¡†çš„è¾…åŠ©å‡½æ•°
    def _clear_project_inputs():
        for k in ["input_client_manual", "input_project", "input_design_manual",
                   "sb_client_select", "sb_design_select"]:
            if k in st.session_state:
                del st.session_state[k]

    import time
    def auto_focus_next(keyword):
        """å¼ºè¡Œæ³¨å…¥ç„¦ç‚¹ï¼ŒåŠ æ—¶é—´æˆ³é˜²æ­¢ç»„ä»¶ç¼“å­˜"""
        uid = time.time()
        js_code = f"""
        <script id="focus-{uid}">
        setTimeout(function() {{
            var doc = window.parent.document;
            var inputs = doc.querySelectorAll('input[type="text"]');
            for (var i = 0; i < inputs.length; i++) {{
                var label = inputs[i].getAttribute('aria-label') || '';
                var placeholder = inputs[i].getAttribute('placeholder') || '';
                if (label.includes('{keyword}') || placeholder.includes('{keyword}')) {{
                    inputs[i].focus();
                    break;
                }}
            }}
        }}, 400); 
        </script>
        """
        components.html(js_code, height=0, width=0)

    with st.expander("â• æ–°å»ºä½œæˆ˜é¡¹ç›® / æ³¨å†Œç”³æŠ¥", expanded=True):
        fk = st.session_state.form_key 
        
        # --- å½»åº•æ”¹ç”¨å†…å­˜ç¼“å­˜å±‚æå–è”æƒ³è¯åº“ ---
        existing_full_names = st.session_state.project_name_cache
        
        existing_clients = sorted(list(set([name.split(" - ")[0] for name in existing_full_names if " - " in name])))
        
        # æå–è®¾è®¡é™¢æ•°æ® (åŸºäºå†…å­˜å…¨åæˆ–å†å²è®°å½•)
        # æ³¨æ„ï¼šå¦‚æœå…¨åä¸­æ²¡æœ‰è®¾è®¡é™¢ä¿¡æ¯ï¼Œè¿™é‡Œå¯èƒ½ä¾ç„¶ä¸ºç©ºï¼Œåç»­å»ºè®®åœ¨æ³¨å†Œæ—¶å°†è®¾è®¡é™¢å•ç‹¬å­˜å…¥ä¸€ä¸ªç¼“å­˜åˆ—è¡¨
        existing_designs = sorted(list(set([name.split(" - ")[2] for name in existing_full_names if name.count(" - ") >= 2])))

        st.markdown("##### ğŸ“ ç¬¬ä¸€æ­¥ï¼šé”å®šç»ˆç«¯å®¢æˆ·")
        client_options = ["â• æ‰‹åŠ¨å½•å…¥æ–°å®¢æˆ·"] + existing_clients
        selected_client_option = st.selectbox(
            "ğŸ¢ å®¢æˆ·/ä¼ä¸šåç§° (ç‚¹æ­¤ç›´æ¥é”®ç›˜æœç´¢)ï¼š", 
            client_options, 
            index=0, 
            key=f"sb_client_select_{fk}"
        )
        
        if selected_client_option == "â• æ‰‹åŠ¨å½•å…¥æ–°å®¢æˆ·":
            client_name = st.text_input("âœï¸ è¯·è¾“å…¥æ–°å®¢æˆ·å…¨ç§° (æŒ‰ Enter å›è½¦è·³è½¬â¬‡ï¸)ï¼š", placeholder="ä¾‹ï¼šä¸‡ååŒ–å­¦", key=f"input_client_manual_{fk}")
        else:
            client_name = selected_client_option
            st.success(f"âœ… å·²é”å®šå®¢æˆ·ï¼š{client_name}")

        st.markdown("---")
        
        # ç„¦ç‚¹å¼•æ“è§¦å‘ï¼šè·³ç¬¬äºŒæ­¥
        if client_name and st.session_state.reg_form_step == 1:
            st.session_state.reg_form_step = 2
            auto_focus_next("äºŒæœŸæŠ€æ”¹") # ç”¨ placeholder ç²¾å‡†åˆ¶å¯¼
            
        if not client_name:
            st.info("ğŸ‘† è¯·å…ˆåœ¨ä¸Šæ–¹ç¡®ç«‹ç»ˆç«¯å®¢æˆ·ã€‚")
        else:
            st.markdown("##### ğŸ¯ ç¬¬äºŒæ­¥ï¼šç¡®ç«‹ä½œæˆ˜é¡¹ç›®")

            # --- ä¿®å¤æ ¸å¿ƒï¼šæ­£ç¡®æå–å½“å‰å®¢æˆ·åä¸‹çš„é¡¹ç›®åˆ—è¡¨ ---
            project_options = ["â• æ–°å»ºä½œæˆ˜é¡¹ç›®"]

            # ä»ç¼“å­˜ä¸­ç­›é€‰å±äºå½“å‰å®¢æˆ·çš„é¡¹ç›® (æ ¼å¼: "å®¢æˆ· - é¡¹ç›®å")
            for full_name in existing_full_names:
                if " - " in full_name:
                    parts = full_name.split(" - ", 1)
                    if parts[0] == client_name:
                        project_options.append(parts[1])  # åªå–é¡¹ç›®åéƒ¨åˆ†

            selected_project = st.selectbox(
                "ğŸ—ï¸ å…·ä½“é¡¹ç›®åç§° (ç‚¹æ­¤ç›´æ¥é”®ç›˜æœç´¢)ï¼š",
                options=project_options,
                index=0,
                key=f"sb_project_select_{fk}"
            )

            if selected_project == "â• æ–°å»ºä½œæˆ˜é¡¹ç›®":
                project_name = st.text_input(
                    "ğŸ“ æ‰‹åŠ¨è¾“å…¥æ–°é¡¹ç›®åç§°ï¼š",
                    placeholder="ä¾‹ï¼šäºŒæœŸ MDI æŠ€æ”¹é¡¹ç›®",
                    key=f"input_project_{fk}"
                )
                is_new_project = True
            else:
                project_name = selected_project
                is_new_project = False
                st.info(f"ğŸ“‚ å·²è°ƒç”¨å†å²é¡¹ç›®æ¡£æ¡ˆï¼š{project_name}")

            st.markdown("---")

            if not project_name:
                st.info("ğŸ‘† è¯·åœ¨ä¸Šæ–¹é€‰æ‹©æˆ–æ–°å»ºä¸€ä¸ªä½œæˆ˜é¡¹ç›®ã€‚")
            else:
                st.markdown("##### ğŸ¤ ç¬¬ä¸‰æ­¥ï¼šå…³è”ç”Ÿæ€ä¼™ä¼´ (å¯é€‰)")

                # 1. é¢„è®¾è¡Œä¸šå¤´éƒ¨è®¾è®¡é™¢/æ€»åŒ…åå• (ç¬¦åˆå¤§å‹å·¥ä¸šé¡¹ç›®é¡¶å±‚è®¾è®¡)
                preset_designs = [
                    "ä¸­å›½çŸ³åŒ–å·¥ç¨‹å»ºè®¾å…¬å¸ (SEI)",
                    "åé™†å·¥ç¨‹ç§‘æŠ€ (åŸåŒ–å·¥éƒ¨ç¬¬å…­è®¾è®¡é™¢)",
                    "ä¸­å›½å¯°çƒå·¥ç¨‹å…¬å¸ (HQCEC)",
                    "ä¸­å›½å¤©è¾°å·¥ç¨‹ (TCC)",
                    "èµ›é¼å·¥ç¨‹ (åŸåŒ–å·¥éƒ¨ç¬¬äºŒè®¾è®¡é™¢)",
                    "ä¸­å»ºä¸‰å±€",
                    "ä¸­å»ºå…«å±€",
                    "åä¸œå»ºç­‘è®¾è®¡ç ”ç©¶é™¢"
                ]

                # 2. ä»å†å²ç¼“å­˜ä¸­åŠ¨æ€æŠ“å–å·²æœ‰çš„è®¾è®¡é™¢
                history_designs = []
                for full_name in existing_full_names:
                    if full_name.count(" - ") >= 2:
                        di = full_name.split(" - ")[2]
                        if di and di not in ["ğŸš« æš‚æ— /ä¸éœ€è¦", ""]:
                            history_designs.append(di)

                # 3. åˆ—è¡¨å»é‡åˆå¹¶
                smart_design_db = sorted(list(set(preset_designs + history_designs)))
                design_options = ["ã€æ‰¾ä¸åˆ°ï¼Ÿç‚¹æ­¤è¾“å…¥æ–°è®¾è®¡é™¢ã€‘", "ğŸš« æš‚æ— /ä¸éœ€è¦"] + smart_design_db

                # 4. æ¸²æŸ“æœç´¢ä¸‹æ‹‰æ¡† (è®¾ä¸º None é»˜è®¤æ‚¬ç©ºï¼Œæå‡æœç´¢ä½“éªŒ)
                selected_design_option = st.selectbox(
                    "ğŸ“ è®¾è®¡é™¢/æ€»åŒ… (ç‚¹æ­¤ç›´æ¥é”®ç›˜æœç´¢)ï¼š",
                    options=design_options,
                    index=None,
                    placeholder="ğŸ” è¯·é€‰æ‹©æˆ–æœç´¢è¡Œä¸šé™¢æ‰€ (é€‰å¡«)",
                    key=f"sb_design_select_{fk}"
                )

                # 5. åˆ†æµé€»è¾‘ï¼šå…¼å®¹ None çš„æƒ…å†µ
                if selected_design_option == "ã€æ‰¾ä¸åˆ°ï¼Ÿç‚¹æ­¤è¾“å…¥æ–°è®¾è®¡é™¢ã€‘":
                    design_institute = st.text_input("âœï¸ è¯·è¾“å…¥è®¾è®¡é™¢/æ€»åŒ…å…¨ç§°ï¼š", placeholder="ä¾‹ï¼šæµ™æ±Ÿçœå¤©æ­£è®¾è®¡å·¥ç¨‹æœ‰é™å…¬å¸", key=f"input_design_manual_{fk}")
                elif selected_design_option == "ğŸš« æš‚æ— /ä¸éœ€è¦" or selected_design_option is None:
                    design_institute = ""
                else:
                    design_institute = selected_design_option
                    st.success(f"âœ… å·²å…³è”ç”Ÿæ€ï¼š{design_institute}")

        full_project_id = f"{client_name} - {project_name}" if client_name and project_name else ""
        
        if client_name and project_name:
            st.markdown("---")

            # --- æ ¹æ®é¡¹ç›®çŠ¶æ€æ™ºèƒ½åˆ†æµ ---
            if is_new_project:
                # åªæœ‰æ–°å»ºé¡¹ç›®æ‰å…è®¸æäº¤å®¡æ‰¹
                if st.button("ğŸš€ æäº¤ç«‹é¡¹å®¡æ ¸", type="primary", use_container_width=True):

                    # 1. é›·è¾¾çº¢åŒºï¼šæ­£å¼åº“ç²¾å‡†æ’å•æ‹¦æˆª (æ‹¦æˆªåŒåé¡¹ç›®)
                    is_formal_collision = full_project_id in existing_full_names

                    # 2. é›·è¾¾é»„åŒºï¼šå®¡æ ¸æ± ç²¾å‡†æ’å•æ‹¦æˆª
                    is_pending_collision = any(
                        p.get("project_name") == full_project_id
                        for p in st.session_state.get("pending_projects", [])
                    )

                    if is_formal_collision:
                        st.error(f"ğŸš¨ ç»å¯¹æ‹¦æˆªï¼šé¡¹ç›®ã€{full_project_id}ã€‘å·²å­˜åœ¨æ­£å¼åº“ä¸­ï¼Œè¯·ç›´æ¥åœ¨å³ä¾§æ²™ç›˜è°ƒç”¨ï¼")
                    elif is_pending_collision:
                        st.error(f"â³ æ’å•æ‹¦æˆªï¼šé¡¹ç›®ã€{full_project_id}ã€‘å·²åœ¨å®¡æ ¸æ± ä¸­æ’é˜Ÿï¼Œè¯·å‹¿é‡å¤æäº¤ï¼")
                    else:
                        # 3. é€šè¿‡é›·è¾¾ï¼Œå®‰å…¨è¿›å…¥å®¡æ ¸æ± 
                        import datetime as _dt_submit
                        timestamp = _dt_submit.datetime.now().strftime('%Y-%m-%d %H:%M:%S')

                        if not isinstance(st.session_state.get("pending_projects"), list):
                            st.session_state.pending_projects = []

                        design_val = locals().get('design_institute', '')
                        st.session_state.pending_projects.append({
                            "client": client_name,
                            "project_name": full_project_id,
                            "design_institute": design_val,
                            "applicant": st.session_state.get("current_user", "æœªçŸ¥"),
                            "dept": st.session_state.get("user_dept", "æœªçŸ¥æˆ˜åŒº"),
                            "time": timestamp,
                        })
                        st.success(f"âœ… ææŠ¥æˆåŠŸï¼é¡¹ç›®ã€{full_project_id}ã€‘å·²æ¨é€è‡³æ€»ç›‘å®¡æ ¸æ± ã€‚")

                        # --- æ ¸å¿ƒï¼šæ ¸å¼¹çº§è‡ªæ¯é‡å»º ---
                        st.session_state.form_key += 1
                        st.session_state.reg_form_step = 1
                        st.rerun()
            else:
                # å¦‚æœè°ƒç”¨çš„æ˜¯è€é¡¹ç›®ï¼Œç»™å‡ºå¼•å¯¼æç¤ºï¼Œéšè—å®¡æ‰¹æŒ‰é’®
                st.info("ğŸ’¡ è¯¥é¡¹ç›®å·²æ˜¯æ­£å¼åœ¨å»ºé¡¹ç›®ã€‚è¯·ç›´æ¥åœ¨å³ä¾§ã€ğŸ—ºï¸ ä½œæˆ˜æ²™ç›˜ã€‘ä¸­è°ƒå–å¹¶å½•å…¥ç°åœºæƒ…æŠ¥ã€‚")

# --- å®¡æ ¸å·¥ä½œå° (ä¾§è¾¹æ å¿«æ·å…¥å£) ---
if st.session_state.pending_projects:
    st.sidebar.markdown("---")
    st.sidebar.error(f"ğŸ”” å¾…åŠï¼šæœ‰ {len(st.session_state.pending_projects)} ä¸ªé¡¹ç›®å¾…å®¡æ ¸")
    with st.sidebar.expander("ğŸ‘®â€â™‚ï¸ æ³¨å†Œå®¡æ ¸å·¥ä½œå°", expanded=True):
        for idx, p in enumerate(list(st.session_state.pending_projects)):
            pid = p.get("project_name", f"æœªçŸ¥é¡¹ç›®_{idx}")
            st.write(f"**{pid}**")
            st.caption(f"ææŠ¥äºº: {p.get('applicant', 'æœªçŸ¥')} | æˆ˜åŒº: {p.get('dept', 'æœªçŸ¥')}")
            c1, c2 = st.columns(2)
            if c1.button("é€šè¿‡", key=f"ok_{idx}_{pid}"):
                # 1. ä»å†…å­˜ç¼“å†²æ± ç§»é™¤
                st.session_state.pending_projects.remove(p)
                # 2. å†™å…¥æ•°æ®åº“
                add_project(pid, "çº¿ç´¢")
                if pid not in st.session_state.project_name_cache:
                    st.session_state.project_name_cache.append(pid)
                # 3. åŒæ­¥å†™å…¥æ­£å¼é¡¹ç›®å®ä½“åº“ (ä¿ç•™å®¡æ‰¹å…ƒæ•°æ®)
                st.session_state.projects[pid] = {
                    "db_id": None,
                    "client": p.get("client", "æœªçŸ¥ä¸šä¸»"),
                    "design_institute": p.get("design_institute", ""),
                    "general_contractor": "",
                    "applicant": p.get("applicant", "æœªçŸ¥"),
                    "dept": p.get("dept", "æœªçŸ¥æˆ˜åŒº"),
                }
                # 4. è§†è§‰åé¦ˆ
                st.session_state.current_project = pid
                st.toast("âœ… å®¡æ ¸é€šè¿‡ï¼å·²å†™å…¥æ•°æ®åº“ã€‚")
                st.rerun()
            if c2.button("é©³å›", key=f"no_{idx}_{pid}"):
                st.session_state.pending_projects.remove(p)
                st.toast("âŒ å·²é©³å›ç”³è¯·")
                st.rerun()
            st.divider()

# --- 1. çœŸå®ä¸‰å±‚ç»„ç»‡æ¶æ„ (å¸¦é«˜ç®¡ç¼–åˆ¶) ---
ORG_CHART = {
    "åä¸œæˆ˜åŒº": ["å¼ ä¸‰", "æå››", "ç‹äº”"],
    "ååŒ—æˆ˜åŒº": ["å­™ä¸ƒ", "å‘¨å…«"],
    "åå—æˆ˜åŒº": ["é˜¿å®", "é˜¿å¼º"],
    "å¤§å®¢æˆ·éƒ¨": ["Linda", "Tony"]
}

# æˆ˜åŒºæ€»ç›‘æ˜ å°„è¡¨
DIRECTORS = {
    "åä¸œæˆ˜åŒº": "ç‹æ€»ç›‘",
    "ååŒ—æˆ˜åŒº": "èµµæ€»ç›‘",
    "åå—æˆ˜åŒº": "é™ˆæ€»ç›‘",
    "å¤§å®¢æˆ·éƒ¨": "æ—æ€»ç›‘"
}

# --- 2. è§’è‰²èº«ä»½ä¸æƒé™çº§è” ---
st.sidebar.markdown("---")
st.sidebar.caption("ğŸ‘¤ å½“å‰ä½œæˆ˜èº«ä»½")

role_type = st.sidebar.selectbox(
    "è¯·é€‰æ‹©èŒèƒ½è§’è‰²:",
    ["ä¸€çº¿é”€å”® (ææŠ¥ç«‹é¡¹)", "åŒºåŸŸæ€»ç›‘ (ç‰‡åŒºå®¡æ‰¹)", "é”€å”®VP (å…¨å±€ç»Ÿç­¹)", "ç³»ç»Ÿç®¡ç†å‘˜"],
    index=0,
    key="role_select"
)

# æå–æ ¸å¿ƒè§’è‰²å (å¦‚ "ä¸€çº¿é”€å”®")
base_role = role_type.split(" ")[0]
st.session_state.role = base_role

if base_role == "ä¸€çº¿é”€å”®":
    selected_dept = st.sidebar.selectbox("ğŸ¢ æ‰€å±æˆ˜åŒº:", options=list(ORG_CHART.keys()))
    selected_name = st.sidebar.selectbox("ğŸ‘‹ é”€å”®å§“å:", options=ORG_CHART[selected_dept])

    st.session_state.current_user = selected_name
    st.session_state.user_dept = selected_dept
    st.sidebar.success(f"å·²ç™»å½•: {selected_name} ({selected_dept})")

elif base_role == "åŒºåŸŸæ€»ç›‘":
    selected_dept = st.sidebar.selectbox("ğŸ¢ åˆ†ç®¡æˆ˜åŒº:", options=list(DIRECTORS.keys()))
    director_name = DIRECTORS[selected_dept]

    st.session_state.current_user = director_name
    st.session_state.user_dept = selected_dept
    st.sidebar.success(f"å·²ç™»å½•: {director_name} ({selected_dept}è´Ÿè´£äºº)")

elif base_role in ["é”€å”®VP", "ç³»ç»Ÿç®¡ç†å‘˜"]:
    # ä¸Šå¸è§†è§’ï¼Œæ²¡æœ‰éƒ¨é—¨é™åˆ¶
    st.session_state.current_user = "é«˜ç®¡/ç®¡ç†å‘˜"
    st.session_state.user_dept = "ALL"
    st.sidebar.success(f"å·²ç™»å½•: {st.session_state.current_user} (æ‹¥æœ‰å…¨å±€ä¸Šå¸è§†è§’)")

# ä¿æŒä¸‹æ¸¸å…¼å®¹ï¼šå°† session_state åŒæ­¥åˆ°å±€éƒ¨å˜é‡ current_user
current_user = st.session_state.current_user

# â”€â”€ ä¸»ç•Œé¢ â”€â”€
st.title("ğŸ¯ SRI åŠ¨æ€é”€å”®æƒ…æŠ¥ç³»ç»Ÿ")

tab_intel, tab_sandbox, tab_academy, tab_knowledge, tab_live_pitch, tab_leader = st.tabs(
    ["ğŸ“ æƒ…æŠ¥å½•å…¥", "ğŸ—ºï¸ ä½œæˆ˜æ²™ç›˜", "ğŸ“ AI ä¼´å­¦ä¸­å¿ƒ", "ğŸ“š æ ¸å¿ƒæŠ€æœ¯æ­¦å™¨åº“", "ğŸ™ï¸ ç¬¬ä¸€ç°åœº", "ğŸ“Š é¢†å¯¼çœ‹æ¿"]
)

# â”€â”€ æƒ…æŠ¥å½•å…¥ â”€â”€
with tab_intel:
    # 1. è·å–é¡¹ç›®åˆ—è¡¨å¹¶é€‰æ‹©
    project_names = get_all_projects()
    if not project_names:
        st.warning("âš ï¸ æš‚æ— é¡¹ç›®ï¼Œè¯·å…ˆåœ¨å·¦ä¾§ä¾§è¾¹æ æ–°å»ºé¡¹ç›®ï¼")
        selected_project = None
        selected_project_id = None
    else:
        project_map = {p[1]: p[0] for p in project_names}
        selected_project = st.selectbox("ğŸ“‚ é€‰æ‹©å…³è”é¡¹ç›®ï¼š", list(project_map.keys()), key="tab1_project_select")
        selected_project_id = project_map[selected_project]

    # 2. æˆ˜å½¹ç«‹é¡¹åŸºåº§
    if selected_project_id:
        st.markdown("### ğŸ›ï¸ æˆ˜å½¹ç«‹é¡¹åŸºåº§ (ç¡¬æ€§èƒŒæ™¯æŒ‡æ ‡)")
        with st.expander("ğŸ“ é¦–æ¬¡å»ºæ¡£ / æ›´æ–°é¡¹ç›®èƒŒæ™¯æŒ‡æ ‡ (æˆ˜ç•¥åŸç‚¹)", expanded=True):
            col_base1, col_base2 = st.columns(2)
            with col_base1:
                # ä¿¡æ¯æ¥æº - å†³å®šæƒ…æŠ¥çš„å¯ä¿¡åº¦
                info_source = st.selectbox(
                    "ğŸ•µï¸\u200dâ™‚ï¸ æ ¸å¿ƒä¿¡æ¯è·å–æ¥æºï¼š",
                    st.session_state.info_sources,
                    key="base_info_source",
                )
                # é©±åŠ¨åŠ› - å†³å®šå®¢æˆ·ç—›ç‚¹æ–¹å‘
                project_driver = st.selectbox(
                    "ğŸš€ ç«‹é¡¹æ ¸å¿ƒé©±åŠ¨åŠ›ï¼š",
                    st.session_state.project_drivers,
                    key="base_project_driver",
                )
            with col_base2:
                # èº«ä½ - å†³å®šè¿›æ”»ç­–ç•¥ (é¢†è·‘vsè·Ÿè·‘)
                current_position = st.selectbox(
                    "ğŸ æˆ‘æ–¹å½“å‰æœ‰åˆ©çŠ¶æ€ (èº«ä½)ï¼š",
                    st.session_state.position_options,
                    key="base_position",
                )
                # é¢„ç®— - å†³å®šå•†åŠ¡ç­–ç•¥
                budget_status = st.selectbox(
                    "ğŸ’° èµ„é‡‘/é¢„ç®—è½å®æƒ…å†µï¼š",
                    st.session_state.budget_statuses,
                    key="base_budget",
                )

            if st.button("ğŸ’¾ é”å®šå¹¶æ³¨å…¥ç«‹é¡¹èƒŒæ™¯æ¡£æ¡ˆ", type="primary", use_container_width=True, key="btn_save_baseline"):
                # 1. æ„é€ é«˜æƒé‡æƒ…æŠ¥æ–‡æœ¬
                baseline_intel = (
                    f"ã€ğŸš¨ ç³»ç»Ÿæ ‡è®°ï¼šæ ¸å¿ƒç«‹é¡¹èƒŒæ™¯åŸºåº§ã€‘\n"
                    f"- ä¿¡æ¯æ¥æºï¼š{info_source}\n"
                    f"- æ ¸å¿ƒé©±åŠ¨åŠ›ï¼š{project_driver}\n"
                    f"- æˆ‘æ–¹å½“å‰èº«ä½ï¼š{current_position}\n"
                    f"- é¢„ç®—çŠ¶æ€ï¼š{budget_status}\n"
                    f"ï¼ˆAIå‚è°‹è¯·æ³¨æ„ï¼šæ­¤ä¸ºé¡¹ç›®åº•å±‚ç¡¬æ€§çº¦æŸï¼Œ"
                    f"åç»­æ‰€æœ‰ç­–ç•¥åˆ†æå¿…é¡»åŸºäºæ­¤èƒŒæ™¯ï¼ï¼‰"
                )

                # 2. è¿½åŠ åˆ° session_state ä¾›å½“å‰ä¼šè¯ä¸­ AI å³æ—¶ä½¿ç”¨
                if "project_data" not in st.session_state:
                    st.session_state.project_data = ""
                st.session_state.project_data += f"\n{baseline_intel}"

                # 3. æŒä¹…åŒ–åˆ°æ•°æ®åº“
                try:
                    save_intelligence(selected_project_id, "[ç«‹é¡¹èƒŒæ™¯åŸºåº§æ›´æ–°]", baseline_intel)
                    position_tag = current_position.split(" ")[0]
                    st.success(f"âœ… æˆ˜å½¹åŸºåº§å·²é”å®šï¼AI å·²æ„ŸçŸ¥æˆ‘æ–¹å½“å‰å¤„äºã€{position_tag}ã€‘çŠ¶æ€ã€‚")
                except Exception as e:
                    st.error(f"ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“è¿æ¥ã€‚é”™è¯¯ä¿¡æ¯ï¼š{e}")

        st.markdown("---")

    # 3. æ·»åŠ æ—¥å¸¸æ¨è¿›åŠ¨æ€
    st.markdown("### âœï¸ æ·»åŠ æ—¥å¸¸æ¨è¿›åŠ¨æ€")

    daily_log = voice_text_area(
        label="âœï¸ é”€å”®å£è¿°æµæ°´è´¦æˆ–ä¼šè®®çºªè¦ï¼š",
        key="input_daily_log",
        placeholder="ä¾‹ï¼šä»Šå¤©è§äº†å¼ æ€»ï¼Œä»–è§‰å¾—ä»·æ ¼åé«˜...",
        height=150
    )
    raw_text = daily_log  # ä¿æŒä¸‹æ¸¸å˜é‡å…¼å®¹

    st.markdown("---")
    st.markdown("### ğŸ“¸ ğŸ‘‚ ç°åœºæƒ…æŠ¥å¤šæ¨¡æ€æ•è· (æ”¯æŒå›¾æ–‡/PDFæ–‡æ¡£)")
    st.info("ğŸ’¡ å®æˆ˜ç©æ³•ï¼šä¸Šä¼ ç«å“é“­ç‰Œç…§ç‰‡ï¼Œæˆ–ã€PDFæ ¼å¼ã€‘çš„æ‹›æ ‡æ–‡ä»¶/æŠ€æœ¯å›¾çº¸ï¼ŒAI å°†è‡ªåŠ¨æç‚¼æ ¸å¿ƒå‚æ•°ï¼")

    # åˆå§‹åŒ–å·²å¤„ç†æ–‡ä»¶æŒ‡çº¹åº“ï¼ˆé˜²é‡å¤æ¶ˆè€— Tokenï¼‰
    if "processed_file_hashes" not in st.session_state:
        st.session_state.processed_file_hashes = set()
    # åˆå§‹åŒ–å½“å‰è§£æçš„è‰ç¨¿æƒ…æŠ¥ï¼ˆç¼“å†²åŒºï¼‰
    if "staged_intel" not in st.session_state:
        st.session_state.staged_intel = ""

    uploaded_file = st.file_uploader("ä¸Šä¼ ç°åœºç…§ç‰‡æˆ–æŠ€æœ¯æ–‡æ¡£æå–æƒ…æŠ¥ (æ”¯æŒ JPG/PNG/PDF)ï¼š", type=["jpg", "jpeg", "png", "pdf"])

    if uploaded_file is not None:
        file_hash = hash(uploaded_file.getvalue())

        # æ‹¦æˆªæœºåˆ¶ï¼šæ£€æŸ¥æ˜¯å¦å·²ç»è§£æè¿‡è¯¥æ–‡ä»¶
        if file_hash in st.session_state.processed_file_hashes:
            st.warning("âš ï¸ ç³»ç»Ÿæ£€æµ‹åˆ°è¯¥æ–‡ä»¶æ­¤å‰å·²è§£æå¹¶å…¥åº“ï¼Œä¸ºé˜²æ­¢æƒ…æŠ¥å†—ä½™ï¼Œå·²æ‹¦æˆªæœ¬æ¬¡é‡å¤è§£ææ“ä½œã€‚")
        else:
            # åªæœ‰å½“å¤„äºæœªè§£æçŠ¶æ€ï¼Œä¸”æš‚å­˜åŒºä¸ºç©ºæ—¶ï¼Œæ‰è§¦å‘å¤§æ¨¡å‹è§£æ
            if st.session_state.get("last_parsed_file") != file_hash:
                with st.spinner("ğŸ‘ï¸ğŸ—¨ï¸ æˆ˜æœ¯ AI æ­£åœ¨æ·±åº¦è§£ææ–‡ä»¶ï¼Œè¯·ç¨å€™..."):
                    try:
                        parsed_intel = ""
                        file_extension = uploaded_file.name.split('.')[-1].lower()

                        from openai import OpenAI as _OpenAI
                        _client = _OpenAI(api_key=api_key)

                        # --- è°ƒç”¨è§£æå¼•æ“ ---
                        if file_extension == 'pdf':
                            pdf_reader = PyPDF2.PdfReader(uploaded_file)
                            extracted_text = "".join([pdf_reader.pages[i].extract_text() + "\n" for i in range(min(5, len(pdf_reader.pages)))])

                            pdf_prompt = f"è¯·æç‚¼ä»¥ä¸‹å®¢æˆ·æ–‡æ¡£çš„æ ¸å¿ƒå•†ä¸šæƒ…æŠ¥ã€å‘(æ’ä»–æ¡æ¬¾)åŠç ´å±€å»ºè®®ï¼š\n{extracted_text[:6000]}"
                            response = _client.chat.completions.create(
                                model="gpt-4o-mini",
                                messages=[{"role": "user", "content": pdf_prompt}]
                            )
                            parsed_intel = response.choices[0].message.content

                        elif file_extension in ['jpg', 'jpeg', 'png']:
                            base64_image = base64.b64encode(uploaded_file.getvalue()).decode('utf-8')
                            response = _client.chat.completions.create(
                                model="gpt-4o-mini",
                                messages=[{
                                    "role": "user",
                                    "content": [
                                        {"type": "text", "text": "è¯·æå–è¿™å¼ ä¸šåŠ¡ç…§ç‰‡ä¸­çš„å“ç‰Œã€å‹å·ã€å…³é”®å‚æ•°ï¼Œå¹¶ç»™å‡ºé”€å”®å»ºè®®ã€‚"},
                                        {"type": "image_url", "image_url": {"url": f"data:image/{file_extension};base64,{base64_image}"}}
                                    ]
                                }]
                            )
                            parsed_intel = response.choices[0].message.content

                        # --- è§£ææˆåŠŸï¼Œæ”¾å…¥ç¼“å†²åŒºè€Œä¸æ˜¯ç›´æ¥å…¥åº“ ---
                        if parsed_intel:
                            st.session_state.staged_intel = f"ã€ğŸš¨ æ·±åº¦æ–‡æ¡£/è§†è§‰æƒ…æŠ¥æå–ã€‘\n{parsed_intel}"
                            st.session_state["last_parsed_file"] = file_hash
                            st.rerun()  # åˆ·æ–°ä»¥æ˜¾ç¤ºç¼–è¾‘åŒº

                    except Exception as e:
                        st.error(f"æ–‡ä»¶è§£æå¤±è´¥ï¼š{e}")

            # --- æ¸²æŸ“æƒ…æŠ¥ç¼“å†²åŒº (Preview & Edit) ---
            if st.session_state.staged_intel:
                st.success("âœ… æ–‡ä»¶è§£ææˆåŠŸï¼è¯·å®¡æŸ¥æç‚¼å‡ºçš„æƒ…æŠ¥ï¼ˆå¯æ‰‹åŠ¨ä¿®æ”¹ï¼‰ã€‚")

                # ç”¨æˆ·å¯ä»¥åœ¨å…¥åº“å‰æ‰‹åŠ¨ä¿®æ”¹ AI çš„æç‚¼ç»“æœ
                edited_intel = st.text_area("ğŸ“ æƒ…æŠ¥ç¼“å†²åŒº (äºŒæ¬¡ç¼–è¾‘)ï¼š", value=st.session_state.staged_intel, height=250)

                # æ­£å¼å…¥åº“æŒ‰é’®
                if st.button("ğŸ§  ç¡®è®¤æ— è¯¯ï¼Œæç‚¼å…¥åº“", type="primary"):
                    current_data = st.session_state.get('project_data', "")
                    st.session_state['project_data'] = (current_data + "\n\n" + edited_intel) if current_data else edited_intel

                    # è®°å½•è¯¥æ–‡ä»¶æŒ‡çº¹ï¼Œå½»åº•æ‹‰é»‘åç»­çš„é‡å¤ä¸Šä¼ 
                    st.session_state.processed_file_hashes.add(file_hash)

                    # æ¸…ç©ºè‰ç¨¿ç®±
                    st.session_state.staged_intel = ""
                    st.session_state["last_parsed_file"] = None

                    st.success("ğŸ¯ æ ¸å¿ƒæƒ…æŠ¥å·²æ­£å¼æ³¨å…¥ä½œæˆ˜æ²™ç›˜ï¼")
                    st.rerun()

    # 4. æç‚¼æŒ‰é’®ä¸å¤„ç†é€»è¾‘
    st.markdown("---")
    if st.button("ğŸ§  æ™ºèƒ½æç‚¼å…¥åº“", type="primary"):
        if not selected_project:
            st.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¡¹ç›®ï¼")
        elif not raw_text and not uploaded_file:
            st.warning("è¯·è‡³å°‘è¾“å…¥æ–‡å­—æˆ–ä¸Šä¼ æ–‡ä»¶ï¼")
        elif not api_key:
            st.warning("âš ï¸ è¯·å…ˆåœ¨å·¦ä¾§ä¾§è¾¹æ è¾“å…¥ API Keyï¼")
        else:
            safe_text = mask_sensitive_info(raw_text) if raw_text else ""
            if safe_text:
                st.info(f"ğŸ›¡ï¸ æ–‡æœ¬å·²è„±æ•ï¼š{safe_text[:80]}...")

            try:
                # åˆ¤æ–­æ˜¯å¦æœ‰å›¾ç‰‡ä¸Šä¼  â†’ èµ°å¤šæ¨¡æ€è§†è§‰è§£æ
                has_image = (uploaded_file is not None
                             and uploaded_file.type.split('/')[0] == 'image')

                with st.spinner("AI æ­£åœ¨æ·±åº¦è§£ææƒ…æŠ¥ä¸­..."):
                    if has_image:
                        st.info("ğŸ” æ£€æµ‹åˆ°å›¾ç‰‡æƒ…æŠ¥ï¼Œå·²å¯ç”¨ GPT-4o-mini å¤šæ¨¡æ€è§†è§‰è§£æ...")
                        image_b64 = encode_image(uploaded_file)
                        parsed_result = parse_visit_log_with_image(
                            api_key, safe_text, image_b64
                        )
                    else:
                        parsed_result = parse_visit_log(api_key, safe_text)

                if parsed_result:
                    save_intelligence(selected_project_id, raw_text, parsed_result)
                    st.success("âœ… æƒ…æŠ¥å·²æˆåŠŸç»“æ„åŒ–å…¥åº“ï¼")
                    st.json(parsed_result)
            except openai.AuthenticationError:
                st.error("âš ï¸ API ç§˜é’¥æ— æ•ˆæˆ–æœªé…ç½®ï¼Œè¯·åœ¨å·¦ä¾§ä¾§è¾¹æ è¾“å…¥æ­£ç¡®çš„ç§˜é’¥ï¼")
            except Exception as e:
                st.error(f"âŒ è§£æå¤±è´¥ï¼š{e}")

# â”€â”€ ä½œæˆ˜æ²™ç›˜ â”€â”€
# â”€â”€ ä½œæˆ˜æ²™ç›˜ â”€â”€
with tab_sandbox:
    render_sandbox_tab()

# â”€â”€ AI ä¼´å­¦ä¸­å¿ƒ â”€â”€
with tab_academy:
    render_learning_tab(api_key)

with tab_knowledge:
    st.markdown("## ğŸ“š ä¸­å¤®æ­¦å™¨åº“ï¼šæŠ€æœ¯å¼¹è¯å……å¡«èˆ±")
    st.caption("ğŸ”’ æƒé™éš”ç¦»ï¼šä»…é™åæ–¹æ ¸å¿ƒæŠ€æœ¯å›¢é˜Ÿä¸é«˜ç®¡è¿›è¡Œå¤šæ¨¡æ€èµ„äº§æ³¨å…¥ã€‚")

    # ================================================================
    # åˆå§‹åŒ– RAG å¼•æ“ï¼ˆå…¨å±€å•ä¾‹ï¼ŒæŒ‚è½½åˆ° session_stateï¼‰
    # ================================================================
    if "rag_engine" not in st.session_state:
        from utils.rag_engine import get_rag_engine
        st.session_state.rag_engine = get_rag_engine()
    
    rag_engine = st.session_state.rag_engine

    # è¯†åˆ«æƒé™
    is_tech_admin = st.session_state.get("role") in ["é”€å”®VP", "åŒºåŸŸæ€»ç›‘", "ç³»ç»Ÿç®¡ç†å‘˜"]

    if is_tech_admin:
        with st.expander("ğŸ”¥ å¼€å¯å¼¹è¯è£…å¡« (æ”¯æŒå¤šæ¨¡æ€è§£æ)", expanded=True):
            st.markdown("#### ğŸ“¥ ç¬¬ä¸€è¾“å…¥å£ï¼šæœ¬åœ°å¤šæ¨¡æ€èµ„äº§")
            col_type, col_upload = st.columns([1, 2])
            with col_type:
                asset_type = st.selectbox(
                    "ğŸ¯ å¼¹è¯å½’å±åˆ†ç±»:", 
                    ["ğŸ“– äº§å“å‚æ•°/ç™½çš®ä¹¦", "ğŸ† å†å²æˆåŠŸç«æ ‡ä¹¦", "ğŸ¬ ç°åœºæ–½å·¥/æ¼”ç¤ºè§†é¢‘", "ğŸ™ï¸ ä¸“å®¶ç­”ç–‘å½•éŸ³"]
                )
            with col_upload:
                uploaded_assets = st.file_uploader(
                    "ğŸ“ æ”¯æŒæ ¼å¼: PDF, TXT, Word, PPT, MP4, MP3", 
                    accept_multiple_files=True, 
                    type=['pdf', 'txt', 'md', 'docx', 'ppt', 'pptx', 'mp4', 'mp3'],
                    key="arsenal_uploader"
                )

            st.markdown("#### ğŸ”— ç¬¬äºŒè¾“å…¥å£ï¼šå¤–éƒ¨æ™ºèƒ½çŸ¥è¯†æº")
            notebooklm_url = st.text_input(
                "ğŸŒ å¼•ç”¨ NotebookLM / ä¼ä¸š Wiki å…±äº«é“¾æ¥:", 
                placeholder="ä¾‹å¦‚: https://notebooklm.google.com/...",
                key="arsenal_url"
            )

            st.markdown("<br>", unsafe_allow_html=True)
            if st.button("ğŸš€ ä¸€é”®å‘é‡åŒ–å¹¶è£…å¡«å…¥åº“ (RAG é¢„å¤„ç†)", type="primary", use_container_width=True):
                if uploaded_assets or notebooklm_url:
                    # å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
                    if uploaded_assets:
                        progress_bar = st.progress(0)
                        status_text = st.empty()
                        
                        success_count = 0
                        fail_count = 0
                        total_chunks = 0
                        
                        for idx, uploaded_file in enumerate(uploaded_assets):
                            try:
                                status_text.text(f"ğŸ§  æ­£åœ¨è§£æ: {uploaded_file.name} ({idx+1}/{len(uploaded_assets)})")
                                
                                # è¯»å–æ–‡ä»¶å­—èŠ‚æµ
                                file_bytes = uploaded_file.read()
                                
                                # è°ƒç”¨ RAG å¼•æ“è§£æ
                                result = rag_engine.process_document(
                                    file_name=uploaded_file.name,
                                    file_bytes=file_bytes,
                                    asset_type=asset_type
                                )
                                
                                if result["success"]:
                                    success_count += 1
                                    total_chunks += result["chunks"]
                                    st.success(result["message"])
                                else:
                                    fail_count += 1
                                    st.warning(result["message"])
                                
                                # æ›´æ–°è¿›åº¦æ¡
                                progress_bar.progress((idx + 1) / len(uploaded_assets))
                                
                            except Exception as e:
                                fail_count += 1
                                st.error(f"âŒ {uploaded_file.name} å¤„ç†å¼‚å¸¸: {str(e)}")
                        
                        status_text.empty()
                        progress_bar.empty()
                        
                        # æœ€ç»ˆæ±‡æŠ¥
                        st.markdown("---")
                        col_s1, col_s2, col_s3 = st.columns(3)
                        col_s1.metric("âœ… æˆåŠŸ", success_count)
                        col_s2.metric("âš ï¸ å¤±è´¥", fail_count)
                        col_s3.metric("ğŸ“¦ çŸ¥è¯†ç¢ç‰‡", total_chunks)
                        
                        if success_count > 0:
                            st.success(f"ğŸ¯ å¼¹è¯è£…å¡«å®Œæ¯•ï¼å…±ç”Ÿæˆ {total_chunks} ä¸ªçŸ¥è¯†ç¢ç‰‡ï¼Œå‰çº¿ã€ç¬¬ä¸€ç°åœºã€‘çš„ AI å¤§è„‘å·²åŒæ­¥æŒ‚è½½ã€‚")
                    
                    # å¤„ç†å¤–éƒ¨é“¾æ¥
                    if notebooklm_url:
                        st.info("ğŸ”— å¤–éƒ¨é“¾æ¥åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…...")
                    
                else:
                    st.error("âš ï¸ æŒ‡æŒ¥å®˜ï¼Œå¼¹è¯èˆ±ä¸ºç©ºï¼Œè¯·å…ˆä¸Šä¼ æ–‡ä»¶æˆ–è¾“å…¥æœ‰æ•ˆé“¾æ¥ï¼")
    else:
        st.info("ğŸ›¡ï¸ æƒé™æ‹¦æˆªï¼šæ‚¨å½“å‰çš„èº«ä»½ä¸ºã€å‰çº¿é”€å”®ã€‘ï¼Œæ— æ³•ç›´æ¥ä¿®æ”¹ä¸­å¤®æ­¦å™¨åº“ã€‚è¯·å‰å¾€ã€ç¬¬ä¸€ç°åœºã€‘è°ƒç”¨å·²æœ‰å¼¹è¯ã€‚")

    st.divider()
    
    # ================================================================
    # åŠ¨æ€æ¸²æŸ“å·²å…¥åº“çš„çŸ¥è¯†èµ„äº§åˆ—è¡¨
    # ================================================================
    st.markdown("### ğŸ—„ï¸ å½“å‰å¯ç”¨å¼¹è¯çŸ©é˜µ (å·²æŒ‚è½½è‡³ç¬¬ä¸€ç°åœº)")
    
    # è·å–ç»Ÿè®¡ä¿¡æ¯
    stats = rag_engine.get_stats()
    all_docs = rag_engine.get_all_documents()
    
    if stats["total_documents"] == 0:
        st.info("ğŸ“­ æ­¦å™¨åº“ä¸ºç©ºï¼Œè¯·ä¸Šä¼ æŠ€æœ¯èµ„äº§ä»¥æ¿€æ´»æ™ºèƒ½æ£€ç´¢èƒ½åŠ›ã€‚")
    else:
        # ç»Ÿè®¡é¢æ¿
        col_stat1, col_stat2, col_stat3, col_stat4 = st.columns(4)
        col_stat1.metric("ğŸ“š æ–‡æ¡£æ€»æ•°", stats["total_documents"])
        col_stat2.metric("ğŸ“¦ çŸ¥è¯†ç¢ç‰‡", stats["total_chunks"])
        col_stat3.metric("ğŸ’¾ æ€»å®¹é‡", f"{stats['total_size'] // 1024} KB")
        
        # æŒ‰ç±»å‹ç»Ÿè®¡
        type_summary = stats.get("by_type", {})
        col_stat4.metric("ğŸ¯ åˆ†ç±»", len(type_summary))
        
        st.markdown("#### ğŸ“‹ å·²å…¥åº“èµ„äº§æ¸…å•")
        
        # ä»¥è¡¨æ ¼å½¢å¼å±•ç¤º
        if all_docs:
            import pandas as pd
            
            df = pd.DataFrame(all_docs)
            df = df[["filename", "asset_type", "chunks", "status", "timestamp"]]
            df.columns = ["æ–‡ä»¶å", "èµ„äº§ç±»å‹", "ç¢ç‰‡æ•°", "çŠ¶æ€", "å…¥åº“æ—¶é—´"]
            
            st.dataframe(
                df,
                use_container_width=True,
                hide_index=True
            )
        
        # æŒ‰ç±»å‹åˆ†ç»„å±•ç¤º
        st.markdown("#### ğŸ¯ åˆ†ç±»è§†å›¾")
        type_cols = st.columns(min(len(type_summary), 4))
        
        for idx, (asset_type, count) in enumerate(type_summary.items()):
            with type_cols[idx % len(type_cols)]:
                st.info(f"**{asset_type}**\n\n{count} ä¸ªç¢ç‰‡")
        
        # ç®¡ç†æ“ä½œ
        if is_tech_admin:
            st.markdown("---")
            with st.expander("ğŸ”§ æ­¦å™¨åº“ç®¡ç†"):
                col_mgmt1, col_mgmt2 = st.columns(2)
                
                with col_mgmt1:
                    if st.button("ğŸ” æµ‹è¯•æœç´¢åŠŸèƒ½", use_container_width=True):
                        test_query = st.text_input("è¾“å…¥å…³é”®è¯æµ‹è¯•:", key="test_search")
                        if test_query:
                            results = rag_engine.simple_search(test_query, top_k=3)
                            st.write(f"æ‰¾åˆ° {len(results)} ä¸ªåŒ¹é…ç»“æœï¼š")
                            for r in results:
                                with st.expander(f"ğŸ“„ {r['filename']} (åŒ¹é…åº¦: {r['score']})"):
                                    st.text(r['content'][:300] + "...")
                
                with col_mgmt2:
                    if st.button("âš ï¸ æ¸…ç©ºæ­¦å™¨åº“", type="secondary", use_container_width=True):
                        if st.checkbox("ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æ•°æ®", key="confirm_clear"):
                            rag_engine.clear_all()
                            st.success("âœ… æ­¦å™¨åº“å·²æ¸…ç©º")
                            st.rerun()

with tab_live_pitch:
    st.markdown("## ğŸ™ï¸ ç¬¬ä¸€ç°åœºï¼šæ²‰æµ¸å¼å®¢æˆ·å±•å…ä¸åŒå‘è¿çº¿")
    st.caption("ğŸ¯ åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œç³»ç»Ÿåˆ†ä¸ºã€å®¢æˆ·æ˜é¢äº¤äº’ã€‘ä¸ã€é”€å”®æˆ˜æœ¯æš—çº¿ã€‘ã€‚")

    # æ¨¡æ‹Ÿå½“å‰å¸¦å…¥ç°åœºçš„é¡¹ç›®ä¸Šä¸‹æ–‡
    live_project_list = list(st.session_state.get("projects", {}).keys()) or ["æš‚æ— é¡¹ç›®"]
    current_live_project = st.selectbox(
        "ğŸ”— ç»‘å®šæœ¬æ¬¡æ‹œè®¿ä½œæˆ˜é¡¹ç›® (ç»§æ‰¿æ²™ç›˜æ•°æ®):",
        live_project_list,
        key="live_pitch_project"
    )
    st.divider()

    # æ„å»ºåŒé¢å±å¸ƒå±€ï¼šå·¦ä¾§ 70% å®¢æˆ·çœ‹ï¼Œå³ä¾§ 30% é”€å”®çœ‹
    col_client, col_sales = st.columns([7, 3])

    with col_client:
        st.markdown("### ğŸ–¥ï¸ å®¢æˆ·äº¤äº’å¤§å± (Client View)")
        st.info("ğŸ–¼ï¸ è¿™é‡Œå°†è½®æ’­æˆ‘ä»¬åœ¨ã€æ ¸å¿ƒæŠ€æœ¯æ­¦å™¨åº“ã€‘ä¸­å‡†å¤‡çš„ 3D æ¨¡å‹ã€æˆåŠŸæ¡ˆä¾‹ä¸æŠ€æœ¯å‚æ•°è¡¨ã€‚")

        # å®¢æˆ·ç›´è¿å¤§æ¨¡å‹é€šé“
        client_query = st.chat_input("ğŸ™ï¸ å®¢æˆ·æˆ–ä¸šåŠ¡å‘˜åœ¨æ­¤è¾“å…¥æŠ€æœ¯ç–‘é—® (æ”¯æŒè¯­éŸ³/æ–‡å­—)...")

        if client_query:
            st.session_state.last_client_query = client_query
            st.toast("æ•æ‰åˆ°ç°åœºäº¤æµä¿¡å·ï¼", icon="ğŸ“¡")

            with st.chat_message("user"):
                st.write(f"**å®¢æˆ·æé—®ï¼š** {client_query}")

            with st.chat_message("assistant"):
                with st.spinner("AI ä¸“å®¶æ­£åœ¨è°ƒå–æ ¸å¿ƒæŠ€æœ¯åº“..."):
                    import time
                    time.sleep(1.5)  # æ¨¡æ‹Ÿå¤§æ¨¡å‹æ€è€ƒå’Œ RAG æ£€ç´¢
                    st.write("æ‚¨å¥½ï¼å…³äºæ‚¨æåˆ°çš„è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çš„äº§å“é‡‡ç”¨äº†æœ€æ–°çš„é˜²è…æ¶‚å±‚æŠ€æœ¯ï¼Œå…¶æ ¸å¿ƒä¼˜åŠ¿åœ¨äº...")
                    st.caption("âœ… ç­”æ¡ˆå·²ç”Ÿæˆã€‚è¿™éƒ¨åˆ†å†…å®¹æ˜¯ç»å¯¹ä¸“ä¸šã€å¯ç›´æ¥å±•ç¤ºç»™å®¢æˆ·çœ‹çš„å®˜æ–¹å›å¤ã€‚")

    with col_sales:
        st.markdown("### ğŸ¥½ æˆ˜æœ¯æŠ¤ç›®é•œ (Sales Only)")
        st.caption("ğŸ¤« ä»…é”€å”®å¯è§çš„å®æ—¶åº•ç‰Œä¸æˆ˜æœ¯æŒ‡å¯¼")

        if st.session_state.get("last_client_query"):
            st.warning(
                "**ğŸ¯ AI æˆ˜æœ¯æç¤ºï¼š**\n\n"
                "å®¢æˆ·é‡ç‚¹å…³æ³¨äº†è¯¥æŠ€æœ¯æŒ‡æ ‡ã€‚"
                "è¯·ç«‹åˆ»å¼•å¯¼å±•ç¤ºã€é•‡æµ·ç‚¼åŒ–ã€‘çš„æ— æ•…éšœè¿è¡Œæ¡ˆä¾‹ï¼\n\n"
                "**ğŸ’° æŠ¥ä»·åº•çº¿ï¼š**\n"
                "å½“å‰æ–¹æ¡ˆåˆ©æ¶¦ç©ºé—´å……è¶³ï¼Œè‹¥å®¢æˆ·çŠ¹è±«ï¼Œ"
                "å¯æ‰¿è¯ºèµ é€ä¸€å¹´å»¶ä¿ã€‚"
            )

            st.markdown("<br>", unsafe_allow_html=True)
            if st.button("ğŸ†˜ å‘¼å«åæ–¹æŠ€æœ¯ç¾¤", use_container_width=True):
                st.success("âœ… å·²å°†ç°åœºç—›ç‚¹ã€å®¢æˆ·åŸè¯æ‰“åŒ…å‘é€è‡³ä¼ä¸šå¾®ä¿¡æŠ€æœ¯ç¾¤ï¼åæ–¹ä¸“å®¶æ­£åœ¨è¿çº¿...")
        else:
            st.markdown("*(ç­‰å¾…æ•æ‰ç°åœºå®¢æˆ·æé—®...)*")

# â”€â”€ é¢†å¯¼çœ‹æ¿ â”€â”€
# â”€â”€ é¢†å¯¼çœ‹æ¿ â”€â”€
with tab_leader:
    render_leader_tab(api_key)
